<!DOCTYPE HTML>
<!--
    Credible Explorer v0.1.1
    Created by Thorsten Neumann and Bao Trung
    Experimental code. Use with care. Prototype
-->
<html>
    <head>
        <title>SmartPesa Credible Explorer</title>
        <script type="text/javascript" src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <body>
        <h1 style="margin-bottom:-8px;">SmartPesa Credible</h1>
        <a href="www.smartpesa.io"><small>www.smartpesa.io</small></a>

        <h3>Wallet Generator</h3>
        Private Key: <input type="text" id="key_private" size="55" value="8p8sk3ZQ2XKwp7PTSxDSC99j33pdo48Z8g6AJE5fF5An"/><br/>
        Public Key:&nbsp; <input type="text" id="key_public" size="50" value="9U95xGb6E2hendFE2F4aGvX5vrepYrht8LFjkVyaazdM"/>
    
        <p />
        <input type="button" id="submit" value="Generate New" onclick="JavaScript:onGenerate()" />

        <h3>Data Post</h3>

        <select name="schema">
            <option value="business">business</option>
            <option value="address">address</option>
        </select>
        <select id="type">
            <option value="business.name">business.name</option>
            <option value="business.registered_name">business.registered_name</option>
            <option value="business.trading_name">business.trading_name</option>
            <option value="business.tax.code">business.tax.code</option>
            <option value="business.tax.enrol_date">business.tax.enrol_date</option>
        </select>
        <input type="text" id="claim" size="30" value="Founders Bakuteh"/>
        <p>
        Output: <i><br/>
            &nbsp;&nbsp;Claim: <span id="claim_hex"></span><br />
            &nbsp;&nbsp;Nonce: <span id="nonce_hex"></span>    
            </i>
        </p>

        Sign ID: <i><span id="sign_id"></span></i><br/>
        Txn ID: <i><span id="txn_id"></span></i>
        <p/>
        <input type="button" id="submit" value="Post" onclick="JavaScript:onSubmit()"/>
        <input type="button" id="submit" value="Transfer" onclick="JavaScript:onTransfer()" />

        <script>
            function requestApi(url, method, data, callback) {
                $.ajax({
                    url: "http://13.251.25.40/rpc-api/" + url,
                    type: method,
                    dataType: 'json',
                    headers: {
                        "Authorization": "Basic " + btoa("SmartPesa:Password"),
                        "Content-Type": "application/json; charset=UTF-8"
                    },
                    data: JSON.stringify(data),
                    success: function (data) {
                        callback(data);
                    },
                    error: function(xhr, textStatus, error) {
                        alert(xhr.responseJSON.message);
                    }
                });
            }

            var previous_private = $("#key_private").val();

            function onGenerate() {
                previous_private = $("#key_private").val();
                requestApi("generatekeypair", "GET", {}, function(data) {
                    $("#key_private").val(data.private_key);
                    $("#key_public").val(data.public_key);
                });
            }
        </script>

        <script>
            function onSubmit() {
                let postData = {
                    claim: $("#claim").val(),
                    type: $("#type").val(),
                    private_key: $("#key_private").val(),
                    public_key: $("#key_public").val(),
                }
                requestApi("add", "POST", postData, function(data) {
                    $("#claim_hex").text(data.claim_hex);
                    $("#nonce_hex").text(data.nonce_hex);
                    $("#sign_id").text(data.sign_id);
                    $("#txn_id").text(data.txn_id);
                });
            }

            function onTransfer() {
                $("#txn_id").text("");                
                let postData = {
                    sign_id: $("#sign_id").text(),
                    from_private_key: previous_private,
                    to_public_key: $("#key_public").val(),
                }
                requestApi("transfer", "POST", postData, function(data) {
                    $("#sign_id").text(data.sign_id);
                    $("#txn_id").text(data.txn_id);
                    //assign current private key to be the new previous
                    previous_private = $("#key_private").val();
                });
            }
        </script>

    </body>
</html>